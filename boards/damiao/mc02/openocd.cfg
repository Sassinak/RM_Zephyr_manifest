source [find interface/cmsis-dap.cfg]

transport select swd

source [find target/stm32h7x.cfg]

adapter speed 1000

# Zephyr on STM32H7 typically links RAM into AXI SRAM (0x2400_0000).
# Our current build places the RTT control block (_SEGGER_RTT) into
# the .rtt_buff_data section starting at 0x2400_0000.
#
# Cortex-Debug/OpenOCD RTT auto search often defaults to 0x2000_0000,
# which misses the control block and yields "No control block found".
proc setup_rtt {} {
    echo "RTT: setup search in AXI SRAM (0x24000000)"
    # Scan a window large enough to cover the RTT section and adjacent data.
    rtt setup 0x24000000 0x20000 "SEGGER RTT"
    rtt start
}

# 只为CPU目标配置RTT（避免重复配置）
proc configure_rtt_for_cpu {} {
    echo "Configuring RTT for CPU target..."
    
    # 配置RTT事件处理 - 只在CPU目标上配置
    stm32h7x.cpu0 configure -event gdb-attach {
        echo "GDB attached - setting up RTT..."
        setup_rtt
    }
    
    stm32h7x.cpu0 configure -event reset-init {
        echo "Reset-init: Setting up RTT..."
        setup_rtt
    }

    # When using runToEntryPoint=main, the CPU will halt at the temporary
    # breakpoint after Zephyr init ran. Configure RTT again at that point so
    # the control block ID is present and detectable.
    stm32h7x.cpu0 configure -event halted {
        echo "CPU halted: Setting up RTT..."
        setup_rtt
    }
}

# 初始化完成后配置RTT
init
after 300 configure_rtt_for_cpu
